set -xe
yacc --version | head -1 | grep 'bison' >> /dev/null 2>&1

rm -rf ../profiling_parser/ >> /dev/null 2>&1 ;
#The original grib_lex.c contains adjustements made from eccodes developers: keep them!
mv grib_lex.c grib_lex.c.orig

mkdir ../profiling_parser/ >> /dev/null 2>&1 ;
export LEX=flex
export LEX_OUT=gribl.c
$LEX -o gribl.c gribl.l
sed 's/yy/grib_yy/g' < $LEX_OUT | sed 's/static void grib_yyunput/void grib_yyunput/' > grib_lex1.c
sed 's/fgetc/getc/g' < grib_lex1.c > grib_lex.c

#rm -f grib_lex1.c
mv grib_lex1.c ../profiling_parser/
#rm -f $LEX_OUT
mv $LEX_OUT ../profiling_parser/
cp -rp grib_lex.c ../profiling_parser/
cp -rp grib_lex.c.orig ../profiling_parser/

#Remember to re-establish the original grib_lex.c
mv grib_lex.c.orig grib_lex.c

yacc -v -d griby.y
sed 's/yy/grib_yy/g' < y.tab.c > grib_yacc1.c
sed 's/fgetc/getc/g' < grib_yacc1.c > grib_yacc.c

#rm -f grib_yacc1.c
mv grib_yacc1.c ../profiling_parser/

sed 's/yy/grib_yy/g' < y.tab.h > grib_yacc.h

#rm -f y.tab.c y.tab.h
mv y.tab.c ../profiling_parser/ ; mv y.tab.h ../profiling_parser/ ;

mv y.output ../profiling_parser/ ;

echo
echo ALL OK
